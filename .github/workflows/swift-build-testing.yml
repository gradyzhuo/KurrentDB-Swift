# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: Swift-build-testing
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Swift ${{ matrix.swift }} on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        swift: ["6.0", "6.1", "6.2"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: SwiftyLab/setup-swift@latest
        with:
           swift-version: ${{ matrix.swift }}
      - run: ulimit -n 10000

      - name: Start KurrentDB cluster
        run: docker compose -f server/docker-compose.yaml up -d

      - name: Wait for cluster to be healthy
        run: |
          echo "Waiting for KurrentDB cluster to be healthy..."
          for i in $(seq 1 60); do
            if curl --fail --insecure https://127.0.0.1:2111/health/live 2>/dev/null && \
               curl --fail --insecure https://127.0.0.1:2112/health/live 2>/dev/null && \
               curl --fail --insecure https://127.0.0.1:2113/health/live 2>/dev/null; then
              echo "All nodes are healthy!"
              exit 0
            fi
            echo "Attempt $i/60 - waiting 5s..."
            sleep 5
          done
          echo "Cluster failed to become healthy"
          docker compose -f server/docker-compose.yaml logs
          exit 1

      - name: Copy generated CA certificate to test resources
        run: |
          docker cp setup:/certs/ca/ca.crt /tmp/ca.crt
          for dir in Tests/*/Resources; do
            cp /tmp/ca.crt "$dir/ca.crt"
          done

      - name: Build
        run: swift build --build-tests --enable-code-coverage
      - name: Swift Testing
        run: swift test -v --skip-build --no-parallel --disable-xctest --enable-swift-testing
      - uses: sersoft-gmbh/swift-coverage-action@v4
        id: coverage-files
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4.0.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ join(fromJSON(steps.coverage-files.outputs.files), ',') }}
